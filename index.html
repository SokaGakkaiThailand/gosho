<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ค้นหาคำศัพท์จากสัทธรรมปุณฑริกสูตร</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center">
  <div id="root"></div>
  <script type="text/babel">
    // Initializing the main SearchApp component
    const SearchApp = () => {
      const [query, setQuery] = React.useState('');
      const [results, setResults] = React.useState([]);
      const [translations, setTranslations] = React.useState([]);
      const [data, setData] = React.useState([]);
      const [loading, setLoading] = React.useState(true);
      const [filter, setFilter] = React.useState('all');

      // Loading and processing CSV data on component mount
      React.useEffect(() => {
        fetch('gosho_english_thai_database20250516.csv')
          .then(response => response.text())
          .then(csvText => {
            Papa.parse(csvText, {
              header: true,
              skipEmptyLines: true,
              dynamicTyping: false,
              transformHeader: header => header.trim().replace(/^"|"$/g, ''),
              transform: (value, header) => {
                let cleaned = value.trim().replace(/^"|"$/g, '');
                return cleaned;
              },
              complete: (results) => {
                const cleanedData = results.data.map(row => ({
                  ...row,
                  'English': row['English'] || '',
                  'ไทย': row['ไทย'] || '',
                  'Chapter name': row['Chapter name'] || '',
                  'paragraph number': row['paragraph number'] || '',
                  'page number (English)': row['page number (English)'] || '',
                  'หน้า (ไทย)': row['หน้า (ไทย)'] || '',
                  'ref/note - to be edited': row['ref/note - to be edited'] || ''
                }));
                setData(cleanedData);
                setLoading(false);
              },
              error: (err) => {
                console.error('Error parsing CSV:', err);
                setLoading(false);
              }
            });
          })
          .catch(err => {
            console.error('Error fetching CSV:', err);
            setLoading(false);
          });
      }, []);

      // Real-time search and translation
      React.useEffect(() => {
        if (!query.trim()) {
          setResults([]);
          setTranslations([]);
          return;
        }

        // Split query into individual words
        const words = query.toLowerCase().split(/\s+/).filter(word => word.length > 0);

        // Find translations for each word (from Glossary)
        const glossaryData = data.filter(row => row['Chapter name'] === 'Glossary/อธิบายศัพท์');
        const wordTranslations = words.map(word => {
          const glossaryEntry = glossaryData.find(row =>
            row['English'].toLowerCase().startsWith(word + ' ')
          );
          if (glossaryEntry) {
            const thaiMatch = glossaryEntry['ไทย'].match(/^[^:]+/); // Extract word before colon
            return {
              word: word,
              thai: thaiMatch ? thaiMatch[0] : glossaryEntry['ไทย']
            };
          }
          return { word: word, thai: null };
        });
        setTranslations(wordTranslations);

        // Search for occurrences of the full query in all chapters
        const lowerQuery = query.toLowerCase();
        const filteredResults = data.filter(row => {
          const matchesQuery = (
            row['English'].toLowerCase().includes(lowerQuery) ||
            row['ไทย'].includes(query) ||
            row['Chapter name'].toLowerCase().includes(lowerQuery) ||
            row['paragraph number'].toLowerCase().includes(lowerQuery)
          );
          const matchesFilter = filter === 'all' || row['Chapter name'] === filter;
          return matchesQuery && matchesFilter;
        });
        setResults(filteredResults);
      }, [query, data, filter]);

      // Extracting unique chapter names for filter
      const uniqueChapters = [...new Set(data.map(row => row['Chapter name']))].filter(ch => ch);

      if (loading) {
        return (
          <div class="text-center mt-10">
            <p class="text-xl font-semibold">กำลังโหลดข้อมูล...</p>
          </div>
        );
      }

      return (
        <div class="w-full max-w-4xl p-4">
          <h1 class="text-2xl font-bold text-center mb-4">ค้นหาคำศัพท์จากสัทธรรมปุณฑริกสูตร</h1>
          <div class="flex flex-col sm:flex-row gap-2 mb-4">
            <input
              type="text"
              value={query}
              onChange={(e) => setQuery(e.target.value)}
              placeholder="พิมพ์คำค้นหา (เช่น คำศัพท์, วลี)"
              class="p-2 border rounded w-full focus:outline-none focus:ring-2 focus:ring-blue-500"
            />
          </div>
          <div class="mb-4">
            <label class="mr-2">กรองตามบท:</label>
            <select
              value={filter}
              onChange={(e) => setFilter(e.target.value)}
              class="p-2 border rounded"
            >
              <option value="all">ทั้งหมด</option>
              {uniqueChapters.map(chapter => (
                <option key={chapter} value={chapter}>{chapter}</option>
              ))}
            </select>
          </div>

          {/* Display translations for each word */}
          {translations.length > 0 && (
            <div class="mb-4">
              <h2 class="text-lg font-semibold">คำแปล:</h2>
              <ul class="list-disc pl-5">
                {translations.map((trans, index) => (
                  <li key={index}>
                    {trans.thai
                      ? `"${trans.word}" หมายถึง "${trans.thai}"`
                      : `"${trans.word}" ไม่พบคำแปลใน Glossary`}
                  </li>
                ))}
              </ul>
            </div>
          )}

          {/* Display search results as sentences */}
          {results.length > 0 ? (
            <div>
              <h2 class="text-lg font-semibold mb-2">ผลลัพธ์การค้นหา:</h2>
              <ul class="list-decimal pl-5 space-y-2">
                {results.map((row, index) => (
                  <li key={index}>
                    The word or phrase "{query}" {row['Chapter name'] === 'Glossary/อธิบายศัพท์' ? 'is defined as' : 'appears in'} Chapter "{row['Chapter name']}", paragraph "{row['paragraph number']}", on page {row['page number (English)']} (English) / หน้า {row['หน้า (ไทย)']} (ไทย).{' '}
                    {row['English'] && <span>English: "{row['English']}". </span>}
                    {row['ไทย'] && <span>ไทย: "{row['ไทย']}". </span>}
                    {row['ref/note - to be edited'] && <span>Note: [{row['ref/note - to be edited']}].</span>}
                  </li>
                ))}
              </ul>
            </div>
          ) : (
            query && <p class="text-center text-red-500">ไม่พบผลลัพธ์สำหรับ "{query}"</p>
          )}
        </div>
      );
    };

    // Render the React component to the DOM
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<SearchApp />);
  </script>
</body>
</html>